**Bounded Contexts Description**

* Payment - everything related to payments: processing, SBP/Acquiring integration, cancellation.
* Customer - focuses on clients data: contracts, personal data
* Wallet - customers' accounts management
* Core - old legacy banking accounting system
* Notification - deals with notifications alerts for clients or employees
* Anti-Fraud / Scoring (AFS) - Fraud and Scoring management of clients.

**Kafka vs RabbitMQ**

| Поток / сценарий                 | Брокер (Kafka / RabbitMQ / нет) | Тип сообщений (event / command / job) | Обоснование выбора                                                                                 |
|----------------------------------|---------------------------------|---------------------------------------|----------------------------------------------------------------------------------------------------|
| PaymentCompleted → Notifications | Kafka                           | event                                 | Событий много, кафка лучше масштабируется для большних данных и данные хранит долго, терять нельзя |
| PaymentRequested → Anti-Fraud    | нет (gRPC sync)                 | -                                     | Синхронно, предварительно проверяем быстро чтоб юзер долго не ждал, проверяем полностью позже      |
| Телеметрия / лог транзакций      | Kafka                           | event                                 | Хранение событий и анализ, лучше кафка                                                             |
| Очередь генерации отчётов        | RabbitMQ                        | job                                   | Точечная задачка, не частая, лучше кролик тут                                                      |
| Auth events → Notifications      | Kafka                           | event                                 | Событий много, кафка лучше масштабируется для большних данных                                      |
| Reports done → Notifications     | Kafka                           | event                                 | Асинхронно, как сделали так и отправим уведомление                                                 |
| Payment cancels → Payments       | Kafka                           | event                                 | Асинхронно, откат платежей не прошедших основные проверки (afc.payment_cancels)                    |

**API Gateway**

Traefik - подходит для сложной платежной системы, команда в основном гошники,
легко если че плагин написать, не требует бд, легко интегрируется с кубом\докером.

**Схема идентификаторов: от sequence к UUIDv7**
1. Для payment_id берем UUIDv7, он хоть и потяжелей, но не требует управления айдишниками устройств. 
Упорядочен по времени, что решает проблему плохой локальности у UUIDv4.
2. Payments: Payments DB - как primary key
Wallet (связь платежей с движениями по кошельку): думаю последний или несколько последних payment_id хранить, которые повлияли на баланс
чтоб понимать что недавно баланс поменяло
в событиях Kafka/Rabbit: любые платежные сообщения включают в себя этот payment_id
в логах и трассировке (correlation id): payment_id как бизнес идентификатор
3. Памяти теперь побольше будет занимать, но масштабировать теперь будет легко, не обяз координация между машинами. 
Старые айдишники в легаси остаются и у нас поле оставим, но для новых там null будет. Старым партнерам переименуем поле и уведомим, на главном поле новое значение. 
Новым - только это новое значение. Старые платежи можно оставить как есть, главное что они все завершенные. 
Выбираем самый неходовой день для миграции и не процессим платежи в это время.
